<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网络技术 - 全量刷题系统 (选项随机版)</title>
    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --bg: #f8f9fa; }
        body { font-family: 'PingFang SC', sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .app-container { width: 100%; max-width: 800px; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); padding: 30px; }
        .meta-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .tag { padding: 5px 15px; border-radius: 50px; color: white; font-size: 14px; font-weight: bold; }
        .tag-single { background: #17a2b8; } .tag-multi { background: #6f42c1; } .tag-judge { background: #fd7e14; }
        .mode-switcher { margin-bottom: 20px; display: flex; gap: 10px; }
        .mode-btn { padding: 8px 15px; border: 1px solid #ccc; border-radius: 5px; cursor: pointer; background: white; }
        .mode-btn.active { background: #333; color: white; border-color: #333; }
        .title { font-size: 19px; color: #333; line-height: 1.5; margin-bottom: 20px; }
        .options-list { display: grid; gap: 10px; }
        .opt-item { padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; }
        .opt-item:hover { border-color: var(--primary); background: #f0f7ff; }
        .opt-item.selected { border-color: var(--primary); background: #e7f1ff; }
        .opt-item input { margin-right: 12px; }
        .feedback { margin-top: 20px; padding: 15px; border-radius: 8px; display: none; }
        .correct-ans { background: #d4edda; color: #155724; border-left: 5px solid var(--success); }
        .wrong-ans { background: #f8d7da; color: #721c24; border-left: 5px solid var(--danger); }
        .controls { margin-top: 30px; display: flex; gap: 10px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-check { background: var(--success); color: white; }
        .btn-next { background: var(--primary); color: white; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .highlight-correct { border-color: var(--success) !important; background: #d4edda !important; }
        .highlight-wrong { border-color: var(--danger) !important; background: #f8d7da !important; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="meta-info">
        <span id="type-tag" class="tag">加载中</span>
        <span id="progress">0 / 0</span>
    </div>
    <div class="mode-switcher">
        <button id="mode-all" class="mode-btn active" onclick="switchMode('all')">全量练习</button>
        <button id="mode-wrong" class="mode-btn" onclick="switchMode('wrong')">错题本 (<span id="wrong-count">0</span>)</button>
    </div>
    <div class="question-box">
        <div id="q-title" class="title">正在初始化...</div>
        <div id="options-area" class="options-list"></div>
    </div>
    <div id="feedback-box" class="feedback"></div>
    <div class="controls">
        <button id="check-btn" class="btn-check" onclick="checkAnswer()">提交答案</button>
        <button id="next-btn" class="btn-next" onclick="nextQuestion()">下一题</button>
    </div>
</div>

<script src="questions.js"></script>
<script>
    let currentMode = 'all';
    let currentPool = [];
    let currentIdx = 0;
    let wrongList = JSON.parse(localStorage.getItem('wrongQuestions')) || [];
    let currentShuffledOptions = []; // 存储当前题目打乱后的选项信息

    function init() {
        updateWrongCount();
        switchMode('all');
    }

    function updateWrongCount() {
        document.getElementById('wrong-count').innerText = wrongList.length;
    }

    function switchMode(mode) {
        currentMode = mode;
        currentIdx = 0;
        document.getElementById('mode-all').classList.toggle('active', mode === 'all');
        document.getElementById('mode-wrong').classList.toggle('active', mode === 'wrong');
        if (mode === 'all') {
            currentPool = [...bank].sort(() => Math.random() - 0.5);
        } else {
            if (wrongList.length === 0) {
                alert("错题本是空的！");
                switchMode('all');
                return;
            }
            currentPool = bank.filter(q => wrongList.includes(q.title)).sort(() => Math.random() - 0.5);
        }
        renderQuestion();
    }

    function renderQuestion() {
        const q = currentPool[currentIdx];
        const optionsArea = document.getElementById('options-area');
        document.getElementById('feedback-box').style.display = 'none';
        document.getElementById('btn-next' ? 'next-btn' : '').disabled = true; // 修正逻辑
        document.getElementById('next-btn').disabled = true;
        document.getElementById('check-btn').disabled = false;
        optionsArea.innerHTML = '';

        document.getElementById('progress').innerText = `${currentIdx + 1} / ${currentPool.length}`;
        document.getElementById('type-tag').innerText = { single: '单选题', multi: '多选题', judge: '判断题' }[q.type];
        document.getElementById('type-tag').className = `tag tag-${q.type}`;
        document.getElementById('q-title').innerText = q.title;

        // --- 核心逻辑：打乱选项 ---
        // 将选项与其原始索引对应，然后打乱顺序
        currentShuffledOptions = q.options.map((content, originalIndex) => ({ content, originalIndex }));
        // 判断题（正确/错误）通常不建议打乱，如果需要打乱可移除下行判断
        if (q.type !== 'judge') {
            currentShuffledOptions.sort(() => Math.random() - 0.5);
        }

        currentShuffledOptions.forEach((opt, displayIndex) => {
            const item = document.createElement('div');
            item.className = 'opt-item';
            const inputType = q.type === 'multi' ? 'checkbox' : 'radio';
            item.innerHTML = `<input type="${inputType}" name="q-opt" value="${opt.originalIndex}"> <label>${opt.content}</label>`;
            
            item.onclick = (e) => {
                if (document.getElementById('check-btn').disabled) return;
                const input = item.querySelector('input');
                if (e.target !== input) input.checked = !input.checked;
                if (q.type !== 'multi') {
                    document.querySelectorAll('.opt-item').forEach(el => el.classList.remove('selected'));
                }
                item.classList.toggle('selected', input.checked);
            };
            optionsArea.appendChild(item);
        });
    }

    function checkAnswer() {
        const q = currentPool[currentIdx];
        const inputs = document.querySelectorAll('input[name="q-opt"]');
        const selectedOriginalIndices = [];
        inputs.forEach(input => { if (input.checked) selectedOriginalIndices.push(parseInt(input.value)); });

        if (selectedOriginalIndices.length === 0) return alert("请选择答案！");

        const isCorrect = JSON.stringify(selectedOriginalIndices.sort()) === JSON.stringify([...q.answer].sort());
        const feedback = document.getElementById('feedback-box');
        feedback.style.display = 'block';

        if (isCorrect) {
            feedback.className = 'feedback correct-ans';
            feedback.innerHTML = `<strong>回答正确！</strong>`;
            if (currentMode === 'wrong') {
                wrongList = wrongList.filter(title => title !== q.title);
                localStorage.setItem('wrongQuestions', JSON.stringify(wrongList));
                updateWrongCount();
            }
        } else {
            const ansText = q.answer.map(i => q.options[i]).join('、');
            feedback.className = 'feedback wrong-ans';
            feedback.innerHTML = `<strong>回答错误。</strong> 正确答案：${ansText}`;
            if (!wrongList.includes(q.title)) {
                wrongList.push(q.title);
                localStorage.setItem('wrongQuestions', JSON.stringify(wrongList));
                updateWrongCount();
            }
        }

        // 高亮显示
        const items = document.querySelectorAll('.opt-item');
        items.forEach(item => {
            const val = parseInt(item.querySelector('input').value);
            if (q.answer.includes(val)) item.classList.add('highlight-correct');
            else if (selectedOriginalIndices.includes(val)) item.classList.add('highlight-wrong');
        });

        document.getElementById('check-btn').disabled = true;
        document.getElementById('next-btn').disabled = false;
    }

    function nextQuestion() {
        currentIdx++;
        if (currentIdx < currentPool.length) renderQuestion();
        else {
            alert(currentMode === 'all' ? "练习结束！" : "错题已练完！");
            switchMode('all');
        }
    }
    window.onload = init;
</script>
</body>
</html>